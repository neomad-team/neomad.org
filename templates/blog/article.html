{% from 'blog/macros.html' import article_list with context %}
{% extends 'layout.html' %}

{% block title %}{{ article.title }}, by {{ article.author|capitalize }}{% endblock %}
{% block description %}{{ article.content|truncate(200) }} by {{ article.author|capitalize }}.{% endblock %}

{% block extra_og %}
{% if article.image %}
<meta property=og:image content="{% if article.image[:4] == 'http' %}{{ article.image }}{% else %}{{ request.url_root[:-1] }}{{ article.image }}{% endif %}">
{% endif %}
<meta property=og:article:published_time content="{{ article.creation_date }}">
<meta property=og:article:author content="{{ article.author|capitalize }}">
<meta property=og:description content="Article « {{ article|striptags|truncate(200) }} », by {{ article.author|capitalize }} on {{ article.creation_date|datetime }}">
{% endblock %}

{% block extra_css %}
<link rel=stylesheet href={{ url_for('static', filename='css/article.css') }}>
<link href=https://cdn.quilljs.com/1.3.4/quill.bubble.css rel="stylesheet">
{% endblock %}

{% block main %}
<article lang={{ article.language }}>
  <section class=meta>
    <a href={{ url_for_user(article.author) }}>
      <img src={{ article.author.avatar }} width=70 height=70 onerror="this.src='{{ url_for('static', filename='images/avatar.png') }}'" alt>
    </a>
    <div>
      <a href={{ url_for_user(article.author) }}>{{ article.author.username }}</a>
      <p>{{ article.author.about|htmlnewline }}</p>
      <time datetime={{ article.creation_date }} pubdate>{{ article.creation_date.strftime('%d %B, %Y') }}</time>
      <p class=reading-time><span>{{ (article.content|length / 6 / 250)|int }}</span> min read</p>
    </div>
  </section>

  {% if errors %}
    <ul>
    {% for error in errors %}
      <li class=error>{{ error }}</li>
    {% endfor %}
    </ul>
  {% endif %}

  {% if not article.publication_date %}
  <div class=ribbon-wrapper>
    <div class=ribbon>draft</div>
  </div>
  {% endif %}
  
  <div id=editor>
    <h1>{{ article.title or 'Insert your title here' }}</h1>
    <div>
      {{ (article.content or '<p>Insert your text here</p>')|safe }}
    </div>
  </div>

</article>

{% if not edit %}
<aside>
  <a href={{ url_for_user(article.author) }}>Read more from {{ article.author }}</a>
</aside>
{% endif %}

{% if edit %}
<link rel=stylesheet href=//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css>
<script src=https://cdn.quilljs.com/1.3.4/quill.js></script>

{% set url = url_for('article_edit', id=article.id) if article.id else url_for('article_create') %}
<form method=post action={{ url }} edit>
  <div class=toolbar>
    <input type=hidden name=title>
    <input type=hidden name=content>
    <input type=hidden name=published>
    <button type=submit class=save>Save as draft</button>
    <button type=submit class=save value=true>Save and publish</button>
    {% if article.id %}
    <a class="button delete" href={{ url_for('article_delete', id=article.id) }}>Delete</a>
    {% endif %}
  </div>
</form>
{% block extra_js %}
<script src={{ url_for('static', filename='js/editor.js') }}></script>
{% endblock %}
{% endif %}
{% endblock %}
